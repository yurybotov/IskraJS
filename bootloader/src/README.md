Описание работы бутлоадера
==========================

    Бутлоадер предназначен для организации заливки кода приложения из среды Ардуино
в платы IskraJS и IskraJS mini. С тем же успехом и с теми же ограничениями его можно
использовать и с другими платами на контроллерах stm32f405 / stm32407 / stm32f411.
    
    Изначально бутлоадер должен быть записан во флэш-память контроллера с помощью st-link
или dfu.
(TODO описать процесс заливки)

    Бутлоадер должен размещаться в нулевом секторе флэш-памяти по адресу `0x08000000`. Память
приложения начинается с первого сектора флэш-памяти по адресу `0x08004000`.

    Запускаясь, бутлоадер создает составное USB устройство на интерфейсе USB-FS. Он состоит из
устройства MSD(mass-storage-device) для загрузки кода приложения и устройства CDC(communication-device-class)
для реализации Ардуино Serial. После создания USB устройств, бутлоадер передает управление на
код приложения.

    Если код приложения неисправен или отсутствует, контроллер в результате оказывается
в нерабочем состоянии. Это произойдет при первой попытке загрузить код (кода еше не было) или 
в случае если приложение пользователя имеет критические ошибки. Для этого есть режим принудительного
обхода кода приложения: надо нажать кнопку User, нажать кнопку Reset, отпустить кнопку Reset, 
потом отпустить кнопку User. После этой последовательности, USB устройства создаются, однако 
управление передается на пустой цикл внутри загрузчика, что позволяет загрузить код нового приложения
в контроллер.

    С точки зрения пользователя, для загрузки кода нового приложения в контроллер, достаточно
скопировать файл прошивки (имя безразлично) на диск создаваемый USB MSD устройством. Однако,
удобнее для этого использовать скрипт на Python: `iskraloader.py`. Он проверит наличие прошивки 
по указанному пути, найдет нужный диск и произведет копирование. 
    Скрипт работает в Windows / Linux / MacOS при наличии Python 3.X.

    В момент начала прошивки существующее пользовательское приложение прекращает работу,
вместо него начинает работать пустой цикл в бутлоадере. Поcле окончании загрузки кода во флэш-память 
бутлоадер рестартует с адреса `0x08000000` - перезапускает USB устройства и передает управление на
адрес `0x08004000` - начало загруженного приложения.

    Ввиду использования загрузчиком, пользователь не должен использовать или рестартовать USB FS 
устройство. Если, он хочет использовать USB для своих целей - он должен вместо USB FS использовать USB HS.

    Есть вещи которые необходимо сделать в загружаемом приложении для того чтобы оно корректно 
работало с данным загрузчиком.
- в .ld файле начало ROM необходимо указать в значение `0x08004000` и значение длины ROM уменьшить на `16` кБайт
- там же начало RAM указать как `0x20001000` и значение длины RAM уменьшить на `4` кБайт
- вектору прерывания USB FS присвоить значение аналогичного вектора загрузчика
- в начале исполнения перенаправить указатель `SCB_VTOR` на таблицу векторов прерываний придожения - `0x08004000`.